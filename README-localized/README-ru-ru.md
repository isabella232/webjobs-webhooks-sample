---
page_type: sample
description: "В этом примере Azure веб-задания показано, как начать получать уведомления от Microsoft Graph."
products:
- ms-graph
languages:
- csharp
extensions:
  contentType: samples
  technologies:
  - Microsoft Graph 
  services:
  - Users
  createdDate: 5/10/2017 5:24:11 PM
---

# Пример веб-перехватчиков Microsoft Graph с помощью пакета SDK веб-заданий
Подпишитесь на [веб-перехватчики Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks) для получения оповещений об изменениях ваших данных пользователя, чтобы не выполнять опрос на изменения.

В этом примере Azure веб заданий показано, как начать получать уведомления от Microsoft Graph. Microsoft Graph предоставляет единую конечную точку API для доступа к данным из Microsoft Cloud. 

>В этом примере используется конечная точка Azure AD, чтобы получить маркер доступа для рабочих или учебных учетных записей. В примере используется разрешение только для приложения, однако делегированные разрешения также должны работать.

Ниже приведены некоторые общие задачи, выполняемые приложением при наличии подписки на веб-перехватчики:

- Получение согласия на подписку на ресурсы пользователей, а затем получение маркера доступа.
- Использование маркера доступа, чтобы [создать подписку](https://developer.microsoft.com/en-us/graph/docs/api-reference/beta/api/subscription_post_subscriptions) на ресурс.
- Возврат маркера проверки для подтверждения URL-адреса уведомления.
- Отслеживание уведомлений из Microsoft Graph и ответ с кодом состояния 202.
- Запрос дополнительных сведений об измененных ресурсах с помощью данных в уведомлении.

После того как приложение создает подписку с использованием маркера авторизации только для приложения, Microsoft Graph отправляет уведомление зарегистрированной конечной точке уведомления, когда в данных пользователя происходят события. Приложение реагирует на событие.

Этот образец подписывается на ресурс `Пользователи` для получения `обновленных` и `удаленных` изменений. В этом примере предполагается, что URL-адрес уведомления - это [функция Azure](https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview), которая прослушивает веб перехватчик через http и немедленно добавляет эти уведомления в очередь хранилища Azure. В этом примере используется [SDK для веб заданий Azure](https://docs.microsoft.com/en-us/azure/app-service-web/websites-dotnet-webjobs-sdk) для привязки к очереди хранилища Azure и получения новых уведомлений, так как они ставятся в очередь функцией Azure.

## Необходимые компоненты

Чтобы использовать пример Microsoft Graph Webhooks с использованием WebJobs SDK, вам необходимо следующее:

* Набор инструментов Visual Studio 2017, установленный на компьютере для разработки. 

* [Рабочая или учебная учетная запись](http://dev.office.com/devprogram)

* Идентификатор приложения и ключ из приложения, которое вы [регистрируете на портале Azure](#register-the-app).

* Открытая конечная точка HTTPS для получения и отправки HTTP-запросов. Вы можете разместить это в Microsoft Azure или другом сервисе. Этот образец был протестирован с использованием функции [Azure](https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview).

* Учетная запись хранения Azure, которая будет использоваться [Azure веб задания SDK](https://docs.microsoft.com/en-us/azure/app-service-web/websites-dotnet-webjobs-sdk) 

### Создание приложения

#### Выбор клиента, в котором вы хотите создать приложение

1. Войдите на [портал Azure](https://portal.azure.com) с помощью рабочей или учебной учетной записи.
1. Если ваша учетная запись содержится в нескольких клиентах Azure AD:
   1. Выберите профиль в меню в правом верхнем углу, а затем выберите пункт **Переключение каталога**.
   1. Измените сеанс на клиента Azure AD, в котором вы хотите создать приложение.

#### Регистрация приложения

1. Перейдите к пункту [Портал Microsoft Azure > Регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908), чтобы зарегистрировать приложение.
![Регистрация приложения](readme-images/aad-app-registration.PNG)
1. Выберите **Новая регистрация**.
![Регистрация Приложения](readme-images/aad-new-registration.PNG)
1. После появления страницы **Регистрация приложения** введите сведения о регистрации для своего приложения:
   1. В разделе **Имя** введите понятное имя, которое будет отображаться для пользователей приложения. Например: `MyWebApp`
   1. В разделе **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации и личные учетные записи Майкрософт (например, Skype, Xbox, Outlook.com)**.
1. Выберите **Зарегистрировать**, чтобы создать приложение.
![Регистрация приложения](readme-images/aad-register-an-app.png)
1. На странице приложения **Обзор** найдите значение **Идентификатор приложения (клиент)** и запишите его, чтобы использовать позже. Вам потребуется это значение, чтобы настроить файл конфигурации Visual Studio для данного проекта.
![Идентификатор приложения](readme-images/aad-application-id.PNG)
1. В списке страниц приложения выберите **Проверка подлинности**.
   1. В разделе **URI перенаправления** выберите параметр **Веб** в поле со списком и введите указанные URI перенаправления.
       - `https://mysigninurl`
	   ![переадресации URI](readme-images/aad-redirect-uri.PNG)
1. Нажмите кнопку **Сохранить**.
1. На странице **Сертификаты и секреты** в разделе **Секреты клиента** выберите **Новый секрет клиента**.
   1. Введите описание ключа (например, `секрет приложения`).
   1. Выберите, когда истекает срок действия ключа: **Через один год**, **Через два года** или **Никогда**.
   ![Секрет клиента](readme-images/aad-new-client-secret.png)
   1. После нажатия на кнопку **Добавить** отобразится значение ключа. Скопируйте значение ключа и сохраните его в безопасном месте.
   ![Секрет клиента](readme-images/aad-copy-client-secret.png)
   Этот ключ понадобится вам позже для настройки проекта в Visual Studio. Это значение ключа больше не будет отображаться и его невозможно получить каким-либо другим способом, поэтому запишите его, как только оно появится на портале Microsoft Azure.
      

1. В списке страниц приложения выберите **Разрешения API**.
   1. Нажмите кнопку **Добавить разрешение** и убедитесь, что выбрана вкладка **Microsoft APIs**.
   1. В разделе **Часто используемые интерфейсы Microsoft API** выберите **Microsoft Graph**
   1. В разделе **Разрешения приложения** убедитесь, что разрешение **Directory.Read.All** проверено. При необходимости используйте поле поиска.
   1. Нажмите кнопку **Добавить разрешения**.

1. На странице **управление**ми выберите **разрешения API** > **добавьте разрешения**.

    ![Снимок экрана: выбор разрешений API](readme-images/aad-api-permissions.PNG)

1. Выберите **Microsoft API** > **Microsoft Graph**.

    ![Снимок экрана: разрешения API запроса](readme-images/aad-request-api-permissions.PNG)

1. Выберите **разрешения приложений**. В поле поиска введите **directory.read.all** и выберите первый вариант из списка. Выберите **Добавить разрешения**.

    ![Скриншот делегированных разрешений](readme-images/aad-application-permissions.PNG)


## Настройте функцию Azure
Чтобы создать подписку и получать уведомления от Microsoft Graph, нужно предоставить открытую конечную точку HTTPS. Вы можете использовать функции Azure для того же.

1. Войдите на [портал Azure](https://portal.azure.com/), используя свою рабочую или учебную учетную запись.

2. Выберите **Function Apps** в левой области навигации.

3. Следуйте инструкциям, чтобы создать новое **Function App**

4. Создать новую функцию **WebHook/API** с помощью приведенного ниже примера кода

```csharp
using System.Net;

public static async Task<HttpResponseMessage> Run(HttpRequestMessage req, ICollector<string> queue, TraceWriter log)
{
    log.Info("C# HTTP trigger function processed a request.");

    // parse query parameter
    string validationToken = req.GetQueryNameValuePairs()
        .FirstOrDefault(q => string.Compare(q.Key, "validationToken", true) == 0)
        .Value;
    
    log.Info("validationToken: " + validationToken);

    // Get request body
    string data = await req.Content.ReadAsStringAsync();

    log.Info("Body of request: " + data);

    queue.Add(data);

    log.Info("Added message to queue");

    return string.IsNullOrWhiteSpace(validationToken)
        ? req.CreateResponse(HttpStatusCode.Accepted, "Notification received")
        : req.CreateResponse(HttpStatusCode.OK, validationToken);
}
```

5. Выберите **Интегрировать** > **новый вывод** > **хранилища Azure Queue**. 

6. Введите `очередь` как **имя параметра сообщения**

7. Введите `webhooksnotificationqueue,` как имя для **очереди**

8. Использовать существующее или создать новое **подключение учетной записи хранения**

9. Выберите созданную функцию и **запустите** на портале, чтобы убедиться в ее успешности.

10. Выберите **Получить функцию URL**, чтобы скопировать URL-адрес уведомления, который будет использоваться в примере.

## Настройка примера проекта

1. В обозревателе решений выберите проект **App.config**

	а. Для ключа **clientId** замените *ENTER_YOUR_APP_ID* идентификатором вашего зарегистрированного приложения Azure.
	
	б. Для ключа **clientSecret** замените *ENTER_YOUR_SECRET* ключом вашего зарегистрированного приложения Azure.  
	
	в. Для ключа **tenantId**замените *ENTER_YOUR_ORGANIZATION_ID* идентификатором вашей организации.

	г. Для ключа **webjobs** замените *ENTER_YOUR_AZURE_STORAGE_CONNECTION_STRING* строкой подключения хранилища Azure, интегрированной в функцию Azure.
	
	e. Для ключа **notificationurl** замените *ENTER_YOUR_NOTIFICATION_URL* URL-адресом функции Azure.

## Используйте образец приложения
1. Нажмите клавишу **F5**, чтобы начать ваш образец.

2. Подождите, пока образец напечатает сообщение. **Создана новая подписка с идентификатором:**

3. Обновите любое свойство любого пользователя в организации. Пример: Обновить свой номер телефона

4. Через несколько минут образец должен получить уведомление для обновленного пользователя вместе с его идентификацией.

5. Каждые 30 секунд образец будет продлевать подписку. Можно изменить период времени обновленной операции, чтобы быть один раз каждые 24 часа.

## Ключевые компоненты примера

**Controllers**  
-[`Function.cs`](https://github.com/microsoftgraph/webjobs-webhooks-sample/blob/master/WebHooksSample/Functions.cs) Управляет подписками и получает уведомления.  
-[`Program.cs`](https://github.com/microsoftgraph/webjobs-webhooks-sample/blob/master/WebHooksSample/SubscriptionController.cs). Начальная загрузка хоста Azure WebJob.
 
## Устранение неполадок

| Выпуск | Разрешение |
| ------ | ------ |
| Вы получаете 403 Запрещенный ответ, когда вы пытаетесь создать подписку. | Убедитесь, что регистрация вашего приложения включает в себя разрешение на **чтение данных каталога данных** для Microsoft Graph (как описано в разделе [Регистрация приложения](#register-the-app)). |  
| Вы не получаете уведомления. | Проверьте журналы для функции Azure на [портале](https://portal.azure.com/). Если приложение Microsoft Graph не отправляет уведомления, откройте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph), вопрос с пометкой *[MicrosoftGraph]*. Включите идентификатор подписки и время ее создания.<br /><br /> |  
| Вы получили *ответ на запрос проверки подписки с истекшим сроком ожидания*. | Это указывает на то, что Microsoft Graph не получил ответ проверки в течение ожидаемого периода времени (около 10 секунд).<br /><br />Если вы создали функцию Azure в **плане потребления**, то функция может перейти в спящий режим из-за неактивности. Образец попытается снова и должен преуспеть в следующих попытках. Или попробуйте создать функцию Azure, используя план обслуживания приложения. |  
| При установке пакетов возникают ошибки. | Убедитесь, что локальный путь к решению не слишком длинный/глубокий. Перемещение решения ближе к корневому диску решает эту проблему. |

<a name="contributing"></a>
## Участие ##

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.MD](/CONTRIBUTING.md).

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [часто задаваемых вопросов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Вопросы и комментарии

Мы хотели бы получить ваши отзывы о образце Microsoft Graph Webhooks с помощью WebJobs SDK. Вы можете отправлять нам вопросы и предложения в разделе [Проблемы](https://github.com/microsoftgraph/webjobs-webhooks-sample/issues) этого репозитория.

Общие вопросы о Microsoft Graph следует задавать на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph). Убедитесь, что ваши вопросы или комментарии содержат метку *[MicrosoftGraph]*.

Если у вас есть предложение по функции, пожалуйста, опубликуйте свою идею на нашей странице [Голос пользователя](https://officespdev.uservoice.com/) и проголосуйте за ваши предложения.

## Дополнительные ресурсы

* [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample)
* [Работа с веб-перехватчиками в Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/webhooks)
* [Ресурс подписки](https://developer.microsoft.com/en-us/graph/docs/api-reference/v1.0/resources/subscription)
* [Сайт разработчика Microsoft Graph](https://developer.microsoft.com/en-us/graph/)
* [Вызов Microsoft Graph в приложении ASP.NET MVC](https://developer.microsoft.com/en-us/graph/docs/platform/aspnetmvc)

© Корпорация Майкрософт (Microsoft Corporation), 2019. Все права защищены.
